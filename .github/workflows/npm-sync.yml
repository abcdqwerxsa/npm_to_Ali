name: NPM Package Sync

on:
  workflow_dispatch:
    inputs:
      package_list:
        description: 'Package list (format: name:version,name:version)'
        required: true
        default: 'n8n:1.112.6,express:4.18.2'
      target_registry:
        description: 'Target registry URL'
        required: true
        default: 'https://packages.aliyun.com/675f933120a07de19c7c12ea/npm/npm-registry/'

jobs:
  sync-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Sync packages to target registry
        env:
          ALIYUN_TOKEN: ${{ secrets.ALIYUN_NPM_TOKEN }}
        run: |
          echo "Starting package sync..."
          echo "Package list: ${{ github.event.inputs.package_list }}"
          echo "Target registry: ${{ github.event.inputs.target_registry }}"
          
          # åˆ›å»º .npmrc æ–‡ä»¶é…ç½®ç›®æ ‡ä»“åº“è®¤è¯
          cat > .npmrc << EOF
          registry=${{ github.event.inputs.target_registry }}
          //packages.aliyun.com/675f933120a07de19c7c12ea/npm/npm-registry/:_authToken=$ALIYUN_TOKEN
          always-auth=true
          EOF
          
          # åˆ†å‰²åŒ…åˆ—è¡¨å¹¶é€ä¸ªå¤„ç†
          IFS=',' read -ra PACKAGE_SPECS <<< "${{ github.event.inputs.package_list }}"
          
          for spec in "${PACKAGE_SPECS[@]}"; do
            echo "Processing: $spec"
            
            # åˆ†å‰²åŒ…åå’Œç‰ˆæœ¬
            IFS=':' read -ra PARTS <<< "$spec"
            PACKAGE_NAME="${PARTS[0]}"
            PACKAGE_VERSION="${PARTS[1]}"
            
            echo "ğŸ“¦ Syncing $PACKAGE_NAME@$PACKAGE_VERSION"
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•
            mkdir -p temp_sync
            cd temp_sync
            
            # ä»å®˜æ–¹æºä¸‹è½½åŒ…
            npm pack "${PACKAGE_NAME}@${PACKAGE_VERSION}" --registry=https://registry.npmjs.org
            
            # è§£å‹åŒ…
            TARBALL=$(ls *.tgz)
            tar -xf "$TARBALL"
            
            # è¿›å…¥åŒ…ç›®å½•å¹¶å‘å¸ƒåˆ°ç›®æ ‡ä»“åº“
            cd package
            npm publish --registry="${{ github.event.inputs.target_registry }}" || echo "âš ï¸  Publish failed or package already exists: $PACKAGE_NAME@$PACKAGE_VERSION"
            
            # è¿”å›å¹¶æ¸…ç†
            cd ../..
            rm -rf temp_sync
            
            echo "âœ… Completed: $PACKAGE_NAME@$PACKAGE_VERSION"
          done
          
          echo "ğŸ‰ All packages synced successfully!"
