name: Sync to Aliyun Artifact Registry

on:
  workflow_dispatch:
    inputs:
      package_list:
        description: 'Package list (name:version,name:version)'
        required: true
        default: 'lodash:4.17.21,express:4.18.2'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Sync packages to Aliyun
        env:
          ALIYUN_TOKEN: ${{ secrets.ALIYUN_NPM_TOKEN }}
        run: |
          echo "=== å¼€å§‹åŒæ­¥åˆ°é˜¿é‡Œäº‘æ•ˆä»“åº“ ==="
          
          IFS=',' read -ra PACKAGES <<< "${{ github.event.inputs.package_list }}"
          
          for spec in "${PACKAGES[@]}"; do
            IFS=':' read -ra PARTS <<< "$spec"
            pkg_name="${PARTS[0]}"
            pkg_version="${PARTS[1]}"
            
            echo "å¤„ç†: $pkg_name@$pkg_version"
            
            mkdir temp_sync && cd temp_sync
            
            # ä¸‹è½½åŒ…ï¼ˆä»å®˜æ–¹æºï¼‰
            npm pack "${pkg_name}@${pkg_version}" --registry=https://registry.npmjs.org
            
            # è§£å‹
            tar -xf *.tgz
            cd package
            
            # è®¾ç½®é˜¿é‡Œäº‘è®¤è¯
            echo "//packages.aliyun.com/675f933120a07de19c7c12ea/npm/npm-registry/:_authToken=$ALIYUN_TOKEN" > .npmrc
            echo "always-auth=true" >> .npmrc
            
            # ğŸ”‘ å…³é”®ä¿®æ”¹ï¼šå¼ºåˆ¶å¿½ç•¥å‘å¸ƒé”™è¯¯
            npm publish --registry=https://packages.aliyun.com/675f933120a07de19c7c12ea/npm/npm-registry/ --loglevel=info || echo "â­ï¸  è·³è¿‡ï¼ˆå¯èƒ½å·²å­˜åœ¨ï¼‰: $pkg_name@$pkg_version"
            
            cd ../..
            rm -rf temp_sync
            echo "âœ… å¤„ç†å®Œæˆ: $pkg_name@$pkg_version"
          done
          
          echo "ğŸ‰ æ‰€æœ‰åŒ…å¤„ç†å®Œæˆï¼"
