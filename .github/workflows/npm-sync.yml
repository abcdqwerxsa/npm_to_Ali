name: NPM Sync with Full Config

on:
  workflow_dispatch:
    inputs:
      package_list:
        description: 'Package list (name:version,name:version)'
        required: true
        default: 'lodash:4.17.21'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Sync with full npmrc
        env:
          ALIYUN_TOKEN: ${{ secrets.ALIYUN_NPM_TOKEN }}
        run: |
          # åˆ›å»ºå®Œæ•´çš„ .npmrc
          cat > .npmrc << 'EOF'
          cache=/home/runner/.npm
          registry=https://packages.aliyun.com/675f933120a07de19c7c12ea/npm/npm-registry/
          always-auth=true
          //packages.aliyun.com/675f933120a07de19c7c12ea/npm/npm-registry/:_authToken=${ALIYUN_TOKEN}
          @nilpotenter:registry=https://packages.aliyun.com/675f933120a07de19c7c12ea/npm/npm-registry/
          sass_binary_site=https://npmmirror.com/mirrors/node-sass/
          phantomjs_cdnurl=https://cdn.npmmirror.com/binaries/phantomjs
          electron_mirror=https://cdn.npmmirror.com/binaries/electron/
          sqlite3_binary_host_mirror=https://foxgis.oss-cn-shanghai.aliyuncs.com/
          chromedriver_cdnurl=https://cdn.npmmirror.com/binaries/chromedriver
          EOF
          
          # å¤„ç†åŒ…åˆ—è¡¨
          IFS=',' read -ra PACKAGES <<< "${{ github.event.inputs.package_list }}"
          
          for spec in "${PACKAGES[@]}"; do
            IFS=':' read -ra PARTS <<< "$spec"
            pkg_name="${PARTS[0]}"
            pkg_version="${PARTS[1]}"
            
            echo "ğŸ”„ Syncing $pkg_name@$pkg_version"
            
            # ä½¿ç”¨ä¸´æ—¶ç›®å½•
            mkdir temp_sync && cd temp_sync
            
            # ä¸‹è½½å’Œå‘å¸ƒ
            npm pack "${pkg_name}@${pkg_version}" --registry=https://registry.npmjs.org
            tar -xf *.tgz
            cd package
            npm publish --loglevel=verbose
            
            cd ../..
            rm -rf temp_sync
            echo "âœ… Synced: $pkg_name@$pkg_version"
          done
